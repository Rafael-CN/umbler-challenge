@page "/"
@using Desafio.Umbler.Client.Components
@using Desafio.Umbler.Client.Models
@using System.Net
@inject HttpClient Http

<PageTitle>Pesquisa de Domínio | Umbler</PageTitle>

<div class="text-center mb-4">
    <h1>Pesquise o seu <br /><span class="text-gradient">domínio</span></h1>
    <p class="text-muted">Digite o domínio que deseja pesquisar e descubra informações sobre ele</p>
</div>

<DomainSearchBox @bind-Value="domainInput"
                 IsLoading="isLoading"
                 OnSearch="SearchDomain" />

<AlertBox Message="@errorMessage"
          Title="@errorTitle"
          Variant="@errorVariant" />

@if (isLoading)
{
    <DomainResultSkeleton />
}
else if (result != null)
{
    <DomainResult Domain="result" />
}

@code {
    private string? domainInput;
    private DomainDTO? result;
    private string? errorMessage;
    private string? errorTitle;
    private AlertBox.AlertVariant errorVariant = AlertBox.AlertVariant.Error;
    private bool isLoading;

    private async Task SearchDomain(string domain)
    {
        errorMessage = null;
        errorTitle = null;
        result = null;

        try
        {
            isLoading = true;
            StateHasChanged();

            result = await Http.GetFromJsonAsync<DomainDTO>($"api/domain/{domain}");
        }
        catch (HttpRequestException ex) when (ex.StatusCode == HttpStatusCode.BadRequest)
        {
            errorTitle = "Domínio inválido";
            errorMessage = "O formato do domínio informado não é válido. Verifique e tente novamente.";
            errorVariant = AlertBox.AlertVariant.Warning;
        }
        catch (HttpRequestException ex) when (ex.StatusCode == HttpStatusCode.NotFound)
        {
            errorTitle = "Domínio não encontrado";
            errorMessage = "Não foi possível encontrar informações de DNS para este domínio.";
            errorVariant = AlertBox.AlertVariant.Info;
        }
        catch (HttpRequestException)
        {
            errorTitle = "Erro de conexão";
            errorMessage = "Não foi possível conectar ao servidor. Verifique sua conexão e tente novamente.";
            errorVariant = AlertBox.AlertVariant.Error;
        }
        catch (Exception)
        {
            errorTitle = "Erro inesperado";
            errorMessage = "Ocorreu um erro inesperado. Por favor, tente novamente mais tarde.";
            errorVariant = AlertBox.AlertVariant.Error;
        }
        finally
        {
            isLoading = false;
        }
    }
}
